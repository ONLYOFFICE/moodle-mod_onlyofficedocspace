{"version":3,"file":"select_element.min.js","sources":["../src/select_element.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module mod_onlyofficedocspace/select_element\n * @copyright  2025 Ascensio System SIA <integration@onlyoffice.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n **/\n/* eslint-disable no-undef */\ndefine(\n    [\n        'core/modal_events',\n        'core/str',\n        'mod_onlyofficedocspace/docspace_integration_sdk',\n        'mod_onlyofficedocspace/select_modal',\n        'mod_onlyofficedocspace/login_modal',\n        'mod_onlyofficedocspace/repository'\n    ],\n    function(ModalEvents, Str, DocspaceIntegrationSDK, DocSpaceSelectModal, DocSpaceLogInModal, Repository) {\n        const STEPS = {\n            LOADING: 'loading',\n            LOGIN: 'login',\n            SELECT_ITEM: 'select_item',\n            DOCSPACE_ITEM: 'docspace_item',\n            ERROR: 'error',\n        };\n\n        const selectors = {\n            frames: {\n                system: \"ds-system-frame\",\n                login: \"ds-login-frame\",\n                select: \"ds-select-frame\",\n            },\n            modal: {\n                ids: {\n                    email: 'ds-login-email',\n                    password: 'ds-login-password',\n                    submit: 'ds-login-submit',\n                    cancel: 'ds-login-cancel',\n                }\n            },\n            select: {\n                ids: {\n                    containers: {\n                        login: 'ds-login-container',\n                        item: 'ds-item-container',\n                        itemInfo: 'ds-item-info',\n                        itemType: 'ds-item-type',\n                        select: 'ds-select-container',\n                        error: 'ds-error',\n                    },\n                    buttons: {\n                        login: 'ds-show-login-modal',\n                        selectRoom: 'ds-select-room',\n                        selectFile: 'ds-select-file',\n                        remove: 'ds-item-remove',\n                    }\n                }\n            }\n        };\n\n        const data = {\n            url: '',\n            user: null,\n            item: null,\n        };\n\n        let state = {step: STEPS.LOADING};\n\n        const setState = function(newState) {\n            state = {...state, ...newState};\n            render();\n        };\n\n        const render = async function() {\n            document.getElementById(selectors.select.ids.containers.item)\n                .classList.toggle('d-none', state.step !== STEPS.DOCSPACE_ITEM);\n            document.getElementById(selectors.select.ids.containers.login)\n                .classList.toggle('d-none', state.step !== STEPS.LOGIN);\n            document.getElementById(selectors.select.ids.containers.error)\n                .classList.toggle('d-none', state.step !== STEPS.ERROR);\n            document.getElementById(selectors.select.ids.containers.select)\n                .classList.toggle('d-none', state.step !== STEPS.SELECT_ITEM);\n\n            if (state.step === STEPS.LOADING) {\n                initDocSpace();\n            }\n            if (state.step === STEPS.DOCSPACE_ITEM) {\n                document.getElementById(selectors.select.ids.containers.itemType)\n                    .querySelector(\"p\").textContent = await Str.getString(\n                        'selecteditemtype:' + data.item.docspaceitemtype,\n                        'onlyofficedocspace'\n                    );\n                document.getElementById(selectors.select.ids.containers.itemInfo)\n                    .querySelector(\"img\").src = data.item.docspaceitemicon;\n                document.getElementById(selectors.select.ids.containers.itemInfo)\n                    .querySelector(\"p\").textContent = data.item.docspaceitemname;\n            }\n        };\n\n        const initDocSpace = async function() {\n            await DocspaceIntegrationSDK.initScript(\"oodsp-api-js\", data.url)\n                .then(async() => {\n                    DocSpace.SDK.initSystem({\n                        frameId: selectors.frames.system,\n                        src: data.url,\n                        events: {\n                            async onAppReady() {\n                                if (data.user && data.user.email && data.user.passwordHash) {\n                                    await authenticateWithDocSpace(\n                                        data.user.email,\n                                        data.user.passwordHash,\n                                        () => {\n                                            setState({\n                                                step: data.item ? STEPS.DOCSPACE_ITEM : STEPS.SELECT_ITEM\n                                            });\n                                        },\n                                        () => {\n                                            setState({step: STEPS.LOGIN});\n                                        }\n                                    );\n                                } else {\n                                    setState({step: STEPS.LOGIN});\n                                }\n                            },\n                            onAppError() {\n                                setState({step: STEPS.ERROR});\n                            }\n                        }\n                    });\n                    return;\n                }).catch(() => {\n                    setState({step: STEPS.ERROR});\n                });\n        };\n\n        const showLoginModal = async function() {\n            await DocSpaceLogInModal.create({\n                templateContext: {\n                    email: data.user ? data.user.email : '',\n                    url: data.url,\n                },\n                removeOnClose: true\n            })\n            .then((modal) => {\n                modal.getRoot().on(ModalEvents.cancel, () => {\n                    modal.destroy();\n                });\n                modal.modal[0].classList.add(\"modal-dialog-centered\");\n                modal.modal[0].style = \"width: 440px;\";\n                modal.show();\n                document.getElementById(selectors.modal.ids.submit)\n                    .addEventListener(\"click\", async function(event) {\n                        const submitButton = event.target;\n                        submitButton.disabled = true;\n\n                        const email = document.getElementById(selectors.modal.ids.email).value.trim();\n                        const password = document.getElementById(selectors.modal.ids.password).value.trim();\n\n                        const docspace = DocSpace.SDK.frames[selectors.frames.system];\n                        const hashSettings = await docspace.getHashSettings();\n                        const passwordHash = await docspace.createHash(password.trim(), hashSettings);\n\n                        await authenticateWithDocSpace(\n                            email,\n                            passwordHash,\n                            async() => {\n                                // eslint-disable-next-line promise/no-nesting\n                                await Repository.updateUserPassword(email, passwordHash)\n                                    .catch((error) => {\n                                        // eslint-disable-next-line no-console\n                                        console.log(error);\n                                    });\n\n                                modal.destroy();\n                                setState({step: STEPS.SELECT_ITEM});\n                            },\n                            () => {\n                                document.getElementById(\"ds-login-error\").style.display = \"block\";\n                            },\n                        );\n                        submitButton.disabled = false;\n                    });\n                document.getElementById(selectors.modal.ids.cancel)\n                    .addEventListener(\"click\", function() {\n                        modal.destroy();\n                    });\n                return;\n            });\n        };\n\n        const showSelectModal = async function(event) {\n            const button = event.target;\n            const selectorType = button.dataset.selectorType;\n            const titleText = selectorType === \"room\"\n                ? await Str.getString('selectroom', 'mod_onlyofficedocspace')\n                : await Str.getString('selectfile', 'mod_onlyofficedocspace');\n\n            const modal = await DocSpaceSelectModal.create({\n                templateContext: {\n                    titleText: titleText\n                },\n                removeOnClose: true\n            });\n            modal.body[0].classList.add(\"p-0\", \"py-2\");\n            modal.modal[0].classList.add(\"modal-dialog-centered\");\n            modal.modal[0].querySelector(\".modal-content\").style = \"width:480px;border-radius: 0\";\n            modal.getRoot().on(ModalEvents.hidden, async() => {\n                await DocSpace.SDK.frames[selectors.frames.select].destroyFrame();\n            });\n            modal.show();\n\n            const config = {\n                frameId: selectors.frames.select,\n                src: data.url,\n                width: \"100%\",\n                height: \"538px\",\n                showSelectorCancel: true,\n                roomType: 6,\n                events: {\n                    onSelectCallback: async function(event) {\n                        const itemInfo = selectorType === \"room\" ? event[0] : event;\n                        const name = selectorType === \"room\" ? itemInfo.label : itemInfo.title + itemInfo.fileExst;\n                        const icon = URL.parse(itemInfo.icon) ?? new URL(itemInfo.icon, data.url);\n                        const requestToken = itemInfo.requestTokens[0].requestToken;\n                        data.item = {\n                            docspaceitemtype: selectorType,\n                            docspaceitemname: name,\n                            docspaceitemicon:icon.href,\n                        };\n                        selectItem(itemInfo.id, selectorType, requestToken, name, icon.href);\n                        setState({step: STEPS.DOCSPACE_ITEM});\n                        modal.destroy();\n                    },\n                    onCloseCallback: function() {\n                        modal.destroy();\n                    }\n                },\n            };\n\n            if (selectorType === \"room\") {\n                config.mode = \"room-selector\";\n            } else if (selectorType === \"file\") {\n                config.mode = \"file-selector\";\n                config.rootPath = \"/rooms/share\";\n                config.selectorType = \"roomsOnly\";\n            }\n\n            DocSpace.SDK.initFrame(config);\n        };\n\n        const authenticateWithDocSpace = async function(email, passwordHash, onSuccess = null, onFail = null) {\n            const docspace = DocSpace.SDK.frames[selectors.frames.system];\n            const docspaceUser = await docspace.getUserInfo();\n\n            if (docspaceUser && docspaceUser.email !== email) {\n                await docspace.logout();\n            }\n\n            await docspace.login(email, passwordHash)\n                .then(result => {\n                    const name = result.name ?? '';\n                    if (name.toLowerCase() === 'error') {\n                        if (onFail) {\n                            onFail();\n                        }\n                    } else {\n                        if (onSuccess) {\n                            onSuccess();\n                        }\n                    }\n                    return;\n                }).catch(() => {\n                    if (onFail) {\n                        onFail();\n                    }\n                });\n        };\n\n        const selectItem = async function(id, type, requestToken, name, icon) {\n            document.getElementsByName(\"docspaceitemid\")[0].value = id;\n            document.getElementsByName(\"docspaceitemtype\")[0].value = type;\n            document.getElementsByName(\"docspacerequesttoken\")[0].value = requestToken;\n            document.getElementsByName(\"docspaceitemname\")[0].value = name;\n            document.getElementsByName(\"docspaceitemicon\")[0].value = icon;\n        };\n\n        const removeItem = async function() {\n            selectItem('', '', '', '', '');\n            setState({step: STEPS.SELECT_ITEM});\n        };\n\n        return {\n            init: async function(url, user, item) {\n                data.url = url;\n                data.user = user;\n                data.item = item;\n\n                // Bind event handlers.\n                document.getElementById(selectors.select.ids.buttons.login).addEventListener('click', showLoginModal);\n                document.getElementById(selectors.select.ids.buttons.selectRoom).addEventListener('click', showSelectModal);\n                // document.getElementById(selectors.select.ids.buttons.selectFile).addEventListener('click', showSelectModal);\n                document.getElementById(selectors.select.ids.buttons.remove).addEventListener('click', removeItem);\n\n                setState({step: STEPS.LOADING});\n            }\n        };\n    });\n/* eslint-enable no-undef*/"],"names":["define","ModalEvents","Str","DocspaceIntegrationSDK","DocSpaceSelectModal","DocSpaceLogInModal","Repository","STEPS","selectors","system","login","select","ids","email","password","submit","cancel","containers","item","itemInfo","itemType","error","buttons","selectRoom","selectFile","remove","data","url","user","state","step","setState","newState","render","async","document","getElementById","classList","toggle","initDocSpace","querySelector","textContent","getString","docspaceitemtype","src","docspaceitemicon","docspaceitemname","initScript","then","DocSpace","SDK","initSystem","frameId","events","passwordHash","authenticateWithDocSpace","onAppError","catch","showLoginModal","create","templateContext","removeOnClose","modal","getRoot","on","destroy","add","style","show","addEventListener","event","submitButton","target","disabled","value","trim","docspace","frames","hashSettings","getHashSettings","createHash","updateUserPassword","console","log","display","showSelectModal","selectorType","dataset","titleText","body","hidden","destroyFrame","config","width","height","showSelectorCancel","roomType","onSelectCallback","name","label","title","fileExst","icon","URL","parse","requestToken","requestTokens","href","selectItem","id","onCloseCallback","mode","rootPath","initFrame","onSuccess","onFail","docspaceUser","getUserInfo","logout","result","toLowerCase","type","getElementsByName","removeItem","init"],"mappings":"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"}