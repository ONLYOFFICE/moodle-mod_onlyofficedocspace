{"version":3,"file":"docspace_users.min.js","sources":["../src/docspace_users.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module mod_onlyofficedocspace/docspace_users\n * @copyright  2025 Ascensio System SIA <integration@onlyoffice.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n **/\n/* eslint-disable no-undef, no-console */\ndefine(\n    [\n        'jquery',\n        'mod_onlyofficedocspace/docspace_integration_sdk',\n        'mod_onlyofficedocspace/password_generator',\n        'mod_onlyofficedocspace/notification',\n        'core/str',\n        'core_form/changechecker',\n        'mod_onlyofficedocspace/repository'\n    ],\n    function($, DocSpaceIntegrationSDK, PasswordGenerator, Notification, Str, ChangeChecker, Repository) {\n        const selectors = {\n            inviteButton: \"button[data-action='invite-to-docspace']\",\n            usersTable: \"table[id='ds-invite-users-table']\",\n            selectAllUsers: \"input[data-action='select-all-users']\",\n            systemFrameId: \"ds-system-frame\",\n        };\n\n        const disableInviteButton = function() {\n            document.querySelector(selectors.inviteButton).setAttribute(\"disabled\", \"\");\n        };\n\n        const enableInviteButton = function() {\n            inviteButton.removeAttribute(\"disabled\");\n        };\n\n        const toggle = function(event) {\n            const checked = event.target.checked;\n            const checkboxes = document.querySelector(selectors.usersTable).querySelectorAll('input[name=\"users\"]');\n            for (var i = 0, n = checkboxes.length; i < n; i++) {\n                checkboxes[i].checked = checked;\n            }\n        };\n\n        const sendInvitations = async function(users) {\n            const docSpace = DocSpace.SDK.frames[selectors.systemFrameId];\n            const hashSettings = await docSpace.getHashSettings();\n\n            for (let user of users) {\n                const hash = await docSpace.createHash(PasswordGenerator.generate(), hashSettings);\n                user.hash = hash;\n            }\n\n            await Repository.inviteUsers(users)\n                // eslint-disable-next-line promise/always-return\n                .then(() => {\n                    window.location.reload();\n                })\n                .catch((error) => {\n                    console.log(error);\n                    enableInviteButton();\n                });\n        };\n\n        const inviteUsers = async function() {\n            if (!DocSpaceIntegrationSDK.initialized()) {\n                Notification.display(await Str.getString(\"docspaceunreachable\", \"onlyofficedocspace\"), \"error\");\n                return;\n            }\n\n            disableInviteButton();\n            const checkboxes = document.getElementsByName(\"users\");\n            let users = [];\n\n            for (var i = 0, n = checkboxes.length; i < n; i++) {\n                if (checkboxes[i].checked) {\n                    users.push({id: checkboxes[i].value});\n                }\n            }\n\n            if (DocSpace.SDK.frames[selectors.systemFrameId]) {\n                sendInvitations(users);\n            } else {\n                DocSpace.SDK.initSystem({\n                    frameId: selectors.systemFrameId,\n                    events: {\n                        onAppReady: async function() {\n                            sendInvitations(users);\n                        },\n                        onAppError: function() {\n                            console.log(\"An error occured while initialising DocSpace Frame.\");\n                            DocSpace.SDK.frames[selectors.systemFrameId].destroyFrame();\n                        }\n                    }\n                });\n            }\n        };\n\n        return {\n            init: async function(url) {\n                ChangeChecker.disableAllChecks();\n                await DocSpaceIntegrationSDK.initScript(\"oodsp-api-js\", url);\n                const toggler = document.querySelector(selectors.selectAllUsers);\n                toggler.addEventListener(\"click\", toggle);\n                inviteButton = document.querySelector(selectors.inviteButton);\n                inviteButton.addEventListener(\"click\", inviteUsers);\n            }\n        };\n    });\n/* eslint-enable no-undef, no-console */"],"names":["define","$","DocSpaceIntegrationSDK","PasswordGenerator","Notification","Str","ChangeChecker","Repository","selectors","toggle","event","checked","target","checkboxes","document","querySelector","querySelectorAll","i","n","length","sendInvitations","async","users","docSpace","DocSpace","SDK","frames","hashSettings","getHashSettings","user","hash","createHash","generate","inviteUsers","then","window","location","reload","catch","error","console","log","inviteButton","removeAttribute","initialized","display","getString","setAttribute","getElementsByName","push","id","value","initSystem","frameId","events","onAppReady","onAppError","destroyFrame","init","url","disableAllChecks","initScript","addEventListener"],"mappings":";;;;;AAqBAA,+CACI,CACI,SACA,kDACA,4CACA,sCACA,WACA,0BACA,sCAEJ,SAASC,EAAGC,uBAAwBC,kBAAmBC,aAAcC,IAAKC,cAAeC,kBAC/EC,uBACY,2CADZA,qBAEU,oCAFVA,yBAGc,wCAHdA,wBAIa,kBAWbC,OAAS,SAASC,aACdC,QAAUD,MAAME,OAAOD,QACvBE,WAAaC,SAASC,cAAcP,sBAAsBQ,iBAAiB,2BAC5E,IAAIC,EAAI,EAAGC,EAAIL,WAAWM,OAAQF,EAAIC,EAAGD,IAC1CJ,WAAWI,GAAGN,QAAUA,SAI1BS,gBAAkBC,eAAeC,aAC7BC,SAAWC,SAASC,IAAIC,OAAOlB,yBAC/BmB,mBAAqBJ,SAASK,sBAE/B,IAAIC,QAAQP,MAAO,OACdQ,WAAaP,SAASQ,WAAW5B,kBAAkB6B,WAAYL,cACrEE,KAAKC,KAAOA,WAGVvB,WAAW0B,YAAYX,OAExBY,MAAK,KACFC,OAAOC,SAASC,YAEnBC,OAAOC,QACJC,QAAQC,IAAIF,OA1BpBG,aAAaC,gBAAgB,gBA+B3BV,YAAcZ,qBACXnB,uBAAuB0C,0BACxBxC,aAAayC,cAAcxC,IAAIyC,UAAU,sBAAuB,sBAAuB,SArC3FhC,SAASC,cAAcP,wBAAwBuC,aAAa,WAAY,UA0ClElC,WAAaC,SAASkC,kBAAkB,aAC1C1B,MAAQ,OAEP,IAAIL,EAAI,EAAGC,EAAIL,WAAWM,OAAQF,EAAIC,EAAGD,IACtCJ,WAAWI,GAAGN,SACdW,MAAM2B,KAAK,CAACC,GAAIrC,WAAWI,GAAGkC,QAIlC3B,SAASC,IAAIC,OAAOlB,yBACpBY,gBAAgBE,OAEhBE,SAASC,IAAI2B,WAAW,CACpBC,QAAS7C,wBACT8C,OAAQ,CACJC,WAAYlC,iBACRD,gBAAgBE,QAEpBkC,WAAY,WACRhB,QAAQC,IAAI,uDACZjB,SAASC,IAAIC,OAAOlB,yBAAyBiD,0BAO1D,CACHC,KAAMrC,eAAesC,KACjBrD,cAAcsD,yBACR1D,uBAAuB2D,WAAW,eAAgBF,KACxC7C,SAASC,cAAcP,0BAC/BsD,iBAAiB,QAASrD,QAClCiC,aAAe5B,SAASC,cAAcP,wBACtCkC,aAAaoB,iBAAiB,QAAS7B"}