{"version":3,"file":"docspace_users.min.js","sources":["../src/docspace_users.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module mod_onlyofficedocspace/docspace_users\n * @copyright  2024 Ascensio System SIA <integration@onlyoffice.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n **/\n/* eslint-disable no-undef, no-console */\ndefine(\n    [\n        'jquery',\n        'mod_onlyofficedocspace/docspace_integration_sdk',\n        'mod_onlyofficedocspace/password_generator',\n        'mod_onlyofficedocspace/notification',\n        'core/str',\n        'core_form/changechecker'\n    ],\n    function($, DocSpaceIntegrationSDK, PasswordGenerator, Notification, Str, ChangeChecker) {\n        const selectors = {\n            inviteButton: \"button[data-action='invite-to-docspace']\",\n            usersTable: \"table[id='ds-invite-users-table']\",\n            selectAllUsers: \"input[data-action='select-all-users']\",\n            systemFrameId: \"ds-system-frame\",\n        };\n\n        const disableInviteButton = function() {\n            document.querySelector(selectors.inviteButton).setAttribute(\"disabled\", \"\");\n        };\n\n        const enableInviteButton = function() {\n            inviteButton.removeAttribute(\"disabled\");\n        };\n\n        const toggle = function(event) {\n            const checked = event.target.checked;\n            const checkboxes = document.querySelector(selectors.usersTable).querySelectorAll('input[name=\"users\"]');\n            for (var i = 0, n = checkboxes.length; i < n; i++) {\n                checkboxes[i].checked = checked;\n            }\n        };\n\n        const sendInvitations = async function(users) {\n            const docSpace = DocSpace.SDK.frames[selectors.systemFrameId];\n            const hashSettings = await docSpace.getHashSettings();\n\n            for (let user of users) {\n                const hash = await docSpace.createHash(PasswordGenerator.generate(), hashSettings);\n                user.hash = hash;\n            }\n\n            const inviteUsersUrl = M.cfg.wwwroot + '/mod/onlyofficedocspace/api/inviteusers.php';\n\n            $.ajax({\n                type: 'POST',\n                url: inviteUsersUrl,\n                dataType: 'json',\n                data: {users: users},\n            }).done(function() {\n                window.location.reload();\n            }).fail(function() {\n                enableInviteButton();\n            });\n        };\n\n        const inviteUsers = async function() {\n            if (!DocSpaceIntegrationSDK.initialized()) {\n                Notification.display(await Str.getString(\"docspaceunreachable\", \"onlyofficedocspace\"), \"error\");\n                return;\n            }\n\n            disableInviteButton();\n            const checkboxes = document.getElementsByName(\"users\");\n            let users = [];\n\n            for (var i = 0, n = checkboxes.length; i < n; i++) {\n                if (checkboxes[i].checked) {\n                    users.push({id: checkboxes[i].value});\n                }\n            }\n\n            if (DocSpace.SDK.frames[selectors.systemFrameId]) {\n                sendInvitations(users);\n            } else {\n                DocSpace.SDK.initSystem({\n                    frameId: selectors.systemFrameId,\n                    events: {\n                        onAppReady: async function() {\n                            sendInvitations(users);\n                        },\n                        onAppError: function() {\n                            console.log(\"An error occured while initialising DocSpace Frame.\");\n                            DocSpace.SDK.frames[selectors.systemFrameId].destroyFrame();\n                        }\n                    }\n                });\n            }\n        };\n\n        return {\n            init: async function(url) {\n                ChangeChecker.disableAllChecks();\n                await DocSpaceIntegrationSDK.initScript(\"oodsp-api-js\", url);\n                const toggler = document.querySelector(selectors.selectAllUsers);\n                toggler.addEventListener(\"click\", toggle);\n                inviteButton = document.querySelector(selectors.inviteButton);\n                inviteButton.addEventListener(\"click\", inviteUsers);\n            }\n        };\n    });\n/* eslint-enable no-undef, no-console */"],"names":["define","$","DocSpaceIntegrationSDK","PasswordGenerator","Notification","Str","ChangeChecker","selectors","toggle","event","checked","target","checkboxes","document","querySelector","querySelectorAll","i","n","length","sendInvitations","async","users","docSpace","DocSpace","SDK","frames","hashSettings","getHashSettings","user","hash","createHash","generate","inviteUsersUrl","M","cfg","wwwroot","ajax","type","url","dataType","data","done","window","location","reload","fail","inviteButton","removeAttribute","inviteUsers","initialized","display","getString","setAttribute","getElementsByName","push","id","value","initSystem","frameId","events","onAppReady","onAppError","console","log","destroyFrame","init","disableAllChecks","initScript","addEventListener"],"mappings":";;;;;AAqBAA,+CACI,CACI,SACA,kDACA,4CACA,sCACA,WACA,4BAEJ,SAASC,EAAGC,uBAAwBC,kBAAmBC,aAAcC,IAAKC,qBAChEC,uBACY,2CADZA,qBAEU,oCAFVA,yBAGc,wCAHdA,wBAIa,kBAWbC,OAAS,SAASC,aACdC,QAAUD,MAAME,OAAOD,QACvBE,WAAaC,SAASC,cAAcP,sBAAsBQ,iBAAiB,2BAC5E,IAAIC,EAAI,EAAGC,EAAIL,WAAWM,OAAQF,EAAIC,EAAGD,IAC1CJ,WAAWI,GAAGN,QAAUA,SAI1BS,gBAAkBC,eAAeC,aAC7BC,SAAWC,SAASC,IAAIC,OAAOlB,yBAC/BmB,mBAAqBJ,SAASK,sBAE/B,IAAIC,QAAQP,MAAO,OACdQ,WAAaP,SAASQ,WAAW3B,kBAAkB4B,WAAYL,cACrEE,KAAKC,KAAOA,WAGVG,eAAiBC,EAAEC,IAAIC,QAAU,8CAEvClC,EAAEmC,KAAK,CACHC,KAAM,OACNC,IAAKN,eACLO,SAAU,OACVC,KAAM,CAACnB,MAAOA,SACfoB,MAAK,WACJC,OAAOC,SAASC,YACjBC,MAAK,WA7BRC,aAAaC,gBAAgB,gBAkC3BC,YAAc5B,qBACXlB,uBAAuB+C,0BACxB7C,aAAa8C,cAAc7C,IAAI8C,UAAU,sBAAuB,sBAAuB,SAxC3FtC,SAASC,cAAcP,wBAAwB6C,aAAa,WAAY,UA6ClExC,WAAaC,SAASwC,kBAAkB,aAC1ChC,MAAQ,OAEP,IAAIL,EAAI,EAAGC,EAAIL,WAAWM,OAAQF,EAAIC,EAAGD,IACtCJ,WAAWI,GAAGN,SACdW,MAAMiC,KAAK,CAACC,GAAI3C,WAAWI,GAAGwC,QAIlCjC,SAASC,IAAIC,OAAOlB,yBACpBY,gBAAgBE,OAEhBE,SAASC,IAAIiC,WAAW,CACpBC,QAASnD,wBACToD,OAAQ,CACJC,WAAYxC,iBACRD,gBAAgBE,QAEpBwC,WAAY,WACRC,QAAQC,IAAI,uDACZxC,SAASC,IAAIC,OAAOlB,yBAAyByD,0BAO1D,CACHC,KAAM7C,eAAekB,KACjBhC,cAAc4D,yBACRhE,uBAAuBiE,WAAW,eAAgB7B,KACxCzB,SAASC,cAAcP,0BAC/B6D,iBAAiB,QAAS5D,QAClCsC,aAAejC,SAASC,cAAcP,wBACtCuC,aAAasB,iBAAiB,QAASpB"}