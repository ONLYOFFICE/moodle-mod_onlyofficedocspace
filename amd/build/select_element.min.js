/**
 * @module mod_onlyofficedocspace/select_element
 * @copyright  2024 Ascensio System SIA <integration@onlyoffice.com>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 **/
define("mod_onlyofficedocspace/select_element",["jquery","core/modal_events","mod_onlyofficedocspace/docspace_integration_sdk","mod_onlyofficedocspace/select_modal","mod_onlyofficedocspace/login_modal","core/str"],(function($,ModalEvents,DocspaceIntegrationSDK,DocSpaceSelectModal,DocSpaceLogInModal,Str){const frames_system="ds-system-frame",frames_login="ds-login-frame",frames_select="ds-select-frame";let user,docspaceUrl,logged=!1;const showLoginForm=function(){document.getElementById("ds-login-form").classList.remove("d-none")},hideLoginForm=function(){document.getElementById("ds-login-form").classList.add("d-none")},showSelectButtons=function(){document.getElementById("ds-select-buttons").classList.remove("d-none")},hideSelectButtons=function(){document.getElementById("ds-select-buttons").classList.add("d-none")},showSelectedItem=function(){document.getElementById("ds-selected-item").classList.remove("d-none")},hideSelectedItem=function(){document.getElementById("ds-selected-item").classList.add("d-none")},selectItem=async function(id,type,requestToken,name,icon){document.getElementsByName("docspaceitemid")[0].value=id,document.getElementsByName("docspaceitemtype")[0].value=type,document.getElementsByName("docspacerequesttoken")[0].value=requestToken,document.getElementsByName("docspaceitemname")[0].value=name,document.getElementsByName("docspaceitemicon")[0].value=icon;document.getElementById("ds-selected-item-type").querySelector("p").textContent=await Str.getString("selecteditemtype:"+type,"mod_onlyofficedocspace");const selectedItemInfo=document.getElementById("ds-selected-item-info");selectedItemInfo.querySelector("img").src=icon,selectedItemInfo.querySelector("p").textContent=name},setState=function(){let state=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";"login"===state?(showLoginForm(),hideSelectButtons(),hideSelectedItem()):"selectors"===state?(showSelectButtons(),hideLoginForm(),hideSelectedItem()):"item"===state?(showSelectedItem(),hideLoginForm(),hideSelectButtons()):(hideLoginForm(),hideSelectedItem(),hideSelectButtons())},displayLoginModal=async function(){await DocSpaceLogInModal.create({templateContext:{email:user.email,url:docspaceUrl},removeOnClose:!0}).then((modal=>{modal.getRoot().on(ModalEvents.hidden,(async()=>{await DocSpace.SDK.frames[frames_login].destroyFrame()})),modal.getRoot().on(ModalEvents.cancel,(()=>{modal.destroy()})),modal.modal[0].classList.add("modal-dialog-centered"),modal.modal[0].style="width: 440px;",modal.show();const docSpace=DocSpace.SDK.initSystem({frameId:frames_login,width:0,height:0});document.querySelector('button[data-action="ds-login-submit"]').addEventListener("click",(async function(){const password=document.getElementById("ds-login-password").value,hashSettings=await docSpace.getHashSettings(),passwordHash=await docSpace.createHash(password.trim(),hashSettings);docSpace.login(user.email,passwordHash).then((async function(response){if(response.status&&200!==response.status)document.getElementById("ds-login-error").style.display="block";else{const updatePasswordUrl=M.cfg.wwwroot+"/mod/onlyofficedocspace/api/updateuserpassword.php";let data={email:user.email,password:passwordHash};$.ajax({type:"POST",url:updatePasswordUrl,dataType:"json",data:data}),modal.destroy(),setState("selectors")}}))})),document.querySelector('button[data-action="ds-login-cancel"]').addEventListener("click",(function(){modal.destroy()}))}))},displaySelectorModal=async function(event){const selectorType=event.target.dataset.selectorType,titleText="room"===selectorType?await Str.getString("selectroom","mod_onlyofficedocspace"):await Str.getString("selectfile","mod_onlyofficedocspace"),modal=await DocSpaceSelectModal.create({templateContext:{titleText:titleText},removeOnClose:!0});modal.body[0].classList.add("p-0","py-2"),modal.modal[0].classList.add("modal-dialog-centered"),modal.modal[0].querySelector(".modal-content").style="width:480px;border-radius: 0",modal.getRoot().on(ModalEvents.hidden,(async()=>{await DocSpace.SDK.frames[frames_select].destroyFrame()})),modal.show();const config={frameId:frames_select,width:"100%",height:"538px",showSelectorCancel:!0,roomType:6,events:{onSelectCallback:async function(event){var _URL$parse;const data="room"===selectorType?event[0]:event,name="room"===selectorType?data.label:data.title+data.fileExst,icon=null!==(_URL$parse=URL.parse(data.icon))&&void 0!==_URL$parse?_URL$parse:new URL(data.icon,docspaceUrl),requestToken=data.requestTokens[0].requestToken;selectItem(data.id,selectorType,requestToken,name,icon.href),setState("item"),modal.destroy()},onCloseCallback:function(){clearSelectedItem(),modal.destroy()}}};"room"===selectorType?config.mode="room-selector":"file"===selectorType&&(config.mode="file-selector",config.rootPath="/rooms/share",config.selectorType="roomsOnly"),DocSpace.SDK.initFrame(config)},clearSelectedItem=function(){selectItem("","","","",""),setState(),logged?setState("selectors"):loginToDocSpace()},loginToDocSpace=async function(){DocSpace.SDK.initSystem({frameId:frames_system,width:"100%",height:"100%",events:{onAppReady:async function(){const docSpace=DocSpace.SDK.frames[frames_system],docSpaceUser=await docSpace.getUserInfo();docSpaceUser&&docSpaceUser.email===user.email?(logged=!0,setState("selectors")):(docSpaceUser&&await docSpace.logout(),logged=!1,user.hash?await docSpace.login(user.email,user.hash).then((function(response){response&&response.status&&200!==response.status?setState("login"):(logged=!0,setState("selectors"))})):setState("login")),await docSpace.destroyFrame()}}})};return{init:async function(url,currentUser,activity){user=currentUser,docspaceUrl=url,await DocspaceIntegrationSDK.initScript("oodsp-api-js",docspaceUrl),activity?(selectItem(activity.docspaceitemid,activity.docspaceitemtype,activity.docspacerequesttoken,activity.docspaceitemname,activity.docspaceitemicon),setState("item")):loginToDocSpace();const selectRoomButton=document.getElementById("ds-select-room"),selectFileButton=document.getElementById("ds-select-file"),removeSelectedItemButton=document.getElementById("remove-selected-item"),loginButton=document.getElementById("ds-login-button");selectRoomButton.addEventListener("click",displaySelectorModal),selectFileButton.addEventListener("click",displaySelectorModal),removeSelectedItemButton.addEventListener("click",clearSelectedItem),loginButton.addEventListener("click",displayLoginModal)}}}));

//# sourceMappingURL=select_element.min.js.map