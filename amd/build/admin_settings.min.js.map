{"version":3,"file":"admin_settings.min.js","sources":["../src/admin_settings.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module mod_onlyofficedocspace/admin_settings\n * @copyright  2024 Ascensio System SIA <integration@onlyoffice.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n **/\n/* eslint-disable no-undef, no-console */\ndefine(\n    [\n        'jquery',\n        'mod_onlyofficedocspace/docspace_integration_sdk',\n        'mod_onlyofficedocspace/password_generator',\n        'mod_onlyofficedocspace/notification',\n        'core/str'\n    ],\n    function ($, DocspaceIntegrationSdk, PasswordGenerator, Notification, Str) {\n        const systemFrameId = \"oodsp-system-frame\";\n        const scriptId = 'oodsp-api-js';\n        let submitButton;\n\n        const updateSettings = async function () {\n            const url = document.getElementById(\"id_s_onlyofficedocspace_docspace_server_url\").value;\n            const email = document.getElementById(\"id_s_onlyofficedocspace_docspace_login\").value;\n            const password = document.getElementsByName(\"s_onlyofficedocspace_docspace_password\")[0].value;\n            const hashSettings = await DocSpace.SDK.frames[systemFrameId].getHashSettings();\n            const passwordHash = await DocSpace\n                .SDK\n                .frames[systemFrameId]\n                .createHash(password.trim(), hashSettings);\n            const randomPasswordHash = await DocSpace\n                .SDK\n                .frames[systemFrameId]\n                .createHash(PasswordGenerator.generate(), hashSettings);\n            const updateSettingsUrl = M.cfg.wwwroot +\n                '/mod/onlyofficedocspace/api/updateadminsettings.php';\n            let data = {\n                url: url,\n                email: email,\n                password: passwordHash,\n                randomPassword: randomPasswordHash\n            };\n            $.ajax({\n                headers: {\n                    Accept: \"application/json\",\n                },\n                type: 'POST',\n                url: updateSettingsUrl,\n                dataType: 'json',\n                data: data,\n            }).done(async function (response) {\n                if (response.status === 201) {\n                    document.getElementsByName(\"s_onlyofficedocspace_docspace_password\")[0]\n                        .value = \"\";\n                    Notification.display(\n                        await Str.getString('adminsettings:updated', 'mod_onlyofficedocspace'),\n                        'success'\n                    );\n                }\n            }).fail(function (jqXHR) {\n                const status = jqXHR.status;\n                if (status === 500 || status === 422) {\n                    const error = jqXHR.responseJSON.error;\n                    Notification.display(error, 'error');\n                }\n            });\n            submitButton.removeAttribute(\"disabled\");\n        };\n\n        return {\n            init: async function (urls) {\n                const settingsForm = document.getElementById(\"adminsettings\");\n                const warningMessage = await Str.getString(\"adminsettings:urlwarning\", \"onlyofficedocspace\");\n\n                if (settingsForm) {\n                    submitButton = settingsForm.querySelector(\"[type='submit']\");\n                    const systemFrameContainer = document.createElement(\"div\");\n                    systemFrameContainer.classList.add(\"d-none\");\n                    const systemFrame = document.createElement(\"div\");\n                    systemFrame.id = systemFrameId;\n                    systemFrameContainer.appendChild(systemFrame);\n                    settingsForm.appendChild(systemFrameContainer);\n\n                    settingsForm.addEventListener(\"submit\", async function (event) {\n                        event.preventDefault();\n                        submitButton.setAttribute(\"disabled\", \"\");\n                        const url = document.getElementById(\"id_s_onlyofficedocspace_docspace_server_url\").value.trim();\n\n                        if (urls.current && url !== urls.current && url !== urls.default && confirm(warningMessage) !== true) {\n                            submitButton.removeAttribute(\"disabled\");\n                            return;\n                        }\n\n                        let script = document.getElementById(scriptId);\n\n                        if (script && script.src !== url + \"/\" + DocspaceIntegrationSdk.apiUrl) {\n                            if (typeof DocSpace !== \"undefined\" && DocSpace !== null) {\n                                await DocSpace.SDK.frames[systemFrameId].destroyFrame();\n                            }\n                            script.remove();\n                            script = null;\n                            window.DocSpace = null;\n                        }\n\n                        if (!script) {\n                            await DocspaceIntegrationSdk.initScript(scriptId, url)\n                                .catch(async () => {\n                                    Notification.display(await Str.getString('docspaceunreachable', 'onlyofficedocspace'), 'error');\n                                });\n                        }\n\n                        if (typeof DocSpace === \"undefined\" || DocSpace === null) {\n                            submitButton.removeAttribute(\"disabled\");\n                            return;\n                        }\n\n                        if (DocSpace.SDK.frames[systemFrameId]) {\n                            updateSettings();\n                        } else {\n                            DocSpace.SDK.initSystem(\n                                {\n                                    frameId: systemFrameId,\n                                    events: {\n                                        \"onAppReady\": async function () {\n                                            updateSettings();\n                                        },\n                                        \"onAppError\": async function (error) {\n                                            console.log(error);\n                                            Notification.display(\n                                                await Str.getString('docspaceapperror', 'onlyofficedocspace'), 'error'\n                                            );\n                                            submitButton.removeAttribute(\"disabled\");\n                                        }\n                                    }\n                                }\n                            );\n                        }\n                    });\n                }\n            }\n        };\n    });\n/* eslint-enable no-undef, no-console */"],"names":["define","$","DocspaceIntegrationSdk","PasswordGenerator","Notification","Str","systemFrameId","submitButton","updateSettings","async","url","document","getElementById","value","email","password","getElementsByName","hashSettings","DocSpace","SDK","frames","getHashSettings","passwordHash","createHash","trim","randomPasswordHash","generate","updateSettingsUrl","M","cfg","wwwroot","data","randomPassword","ajax","headers","Accept","type","dataType","done","response","status","display","getString","fail","jqXHR","error","responseJSON","removeAttribute","init","urls","settingsForm","warningMessage","querySelector","systemFrameContainer","createElement","classList","add","systemFrame","id","appendChild","addEventListener","event","preventDefault","setAttribute","current","default","confirm","script","src","apiUrl","destroyFrame","remove","window","initScript","catch","initSystem","frameId","events","console","log"],"mappings":";;;;;AAqBAA,+CACI,CACI,SACA,kDACA,4CACA,sCACA,aAEJ,SAAUC,EAAGC,uBAAwBC,kBAAmBC,aAAcC,WAC5DC,cAAgB,yBAElBC,mBAEEC,eAAiBC,uBACbC,IAAMC,SAASC,eAAe,+CAA+CC,MAC7EC,MAAQH,SAASC,eAAe,0CAA0CC,MAC1EE,SAAWJ,SAASK,kBAAkB,0CAA0C,GAAGH,MACnFI,mBAAqBC,SAASC,IAAIC,OAAOd,eAAee,kBACxDC,mBAAqBJ,SACtBC,IACAC,OAAOd,eACPiB,WAAWR,SAASS,OAAQP,cAC3BQ,yBAA2BP,SAC5BC,IACAC,OAAOd,eACPiB,WAAWpB,kBAAkBuB,WAAYT,cACxCU,kBAAoBC,EAAEC,IAAIC,QAC5B,0DACAC,KAAO,CACPrB,IAAKA,IACLI,MAAOA,MACPC,SAAUO,aACVU,eAAgBP,oBAEpBxB,EAAEgC,KAAK,CACHC,QAAS,CACLC,OAAQ,oBAEZC,KAAM,OACN1B,IAAKiB,kBACLU,SAAU,OACVN,KAAMA,OACPO,MAAK7B,eAAgB8B,UACI,MAApBA,SAASC,SACT7B,SAASK,kBAAkB,0CAA0C,GAChEH,MAAQ,GACbT,aAAaqC,cACHpC,IAAIqC,UAAU,wBAAyB,0BAC7C,eAGTC,MAAK,SAAUC,aACRJ,OAASI,MAAMJ,UACN,MAAXA,QAA6B,MAAXA,OAAgB,OAC5BK,MAAQD,MAAME,aAAaD,MACjCzC,aAAaqC,QAAQI,MAAO,aAGpCtC,aAAawC,gBAAgB,mBAG1B,CACHC,KAAMvC,eAAgBwC,YACZC,aAAevC,SAASC,eAAe,iBACvCuC,qBAAuB9C,IAAIqC,UAAU,2BAA4B,yBAEnEQ,aAAc,CACd3C,aAAe2C,aAAaE,cAAc,yBACpCC,qBAAuB1C,SAAS2C,cAAc,OACpDD,qBAAqBE,UAAUC,IAAI,gBAC7BC,YAAc9C,SAAS2C,cAAc,OAC3CG,YAAYC,GAAKpD,cACjB+C,qBAAqBM,YAAYF,aACjCP,aAAaS,YAAYN,sBAEzBH,aAAaU,iBAAiB,UAAUnD,eAAgBoD,OACpDA,MAAMC,iBACNvD,aAAawD,aAAa,WAAY,UAChCrD,IAAMC,SAASC,eAAe,+CAA+CC,MAAMW,UAErFyB,KAAKe,SAAWtD,MAAQuC,KAAKe,SAAWtD,MAAQuC,KAAKgB,UAAuC,IAA5BC,QAAQf,4BACxE5C,aAAawC,gBAAgB,gBAI7BoB,OAASxD,SAASC,eA3ErB,gBA6EGuD,QAAUA,OAAOC,MAAQ1D,IAAM,IAAMR,uBAAuBmE,SACpC,oBAAbnD,UAAyC,OAAbA,gBAC7BA,SAASC,IAAIC,OAAOd,eAAegE,eAE7CH,OAAOI,SACPJ,OAAS,KACTK,OAAOtD,SAAW,MAGjBiD,cACKjE,uBAAuBuE,WAvFhC,eAuFqD/D,KAC7CgE,OAAMjE,UACHL,aAAaqC,cAAcpC,IAAIqC,UAAU,sBAAuB,sBAAuB,YAI3E,oBAAbxB,UAAyC,OAAbA,SAKnCA,SAASC,IAAIC,OAAOd,eACpBE,iBAEAU,SAASC,IAAIwD,WACT,CACIC,QAAStE,cACTuE,OAAQ,YACUpE,iBACVD,6BAEUC,eAAgBoC,OAC1BiC,QAAQC,IAAIlC,OACZzC,aAAaqC,cACHpC,IAAIqC,UAAU,mBAAoB,sBAAuB,SAEnEnC,aAAawC,gBAAgB,gBAnB7CxC,aAAawC,gBAAgB"}
