{"version":3,"file":"admin_settings.min.js","sources":["../src/admin_settings.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module     mod_onlyofficedocspace/admin_settings\n * @copyright  2025 Ascensio System SIA <integration@onlyoffice.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n **/\ndefine([\n    'core/notification',\n    'core/str',\n    'mod_onlyofficedocspace/repository',\n], function(Notification, Str, Repository) {\n\n    const selectors = {\n        notifications: '#user-notifications',\n        fieldRows: {\n            url: '#admin-docspace_server_url',\n            apiKey: '#admin-docspace_api_key',\n        },\n        icons: {\n            rightArrow: \".right-arrow\",\n            spinner: \".spinner-border\",\n            checkMark: \"#input-check-icon\",\n        },\n        buttons: {\n            checkUrl: \"#check-docspace-url-btn\",\n            connect: \"#connect-docspace-btn\",\n            change: \"#change-docspace-btn\",\n            disconnect: \"#disconnect-docspace-btn\",\n        },\n        inputs: {\n            url: '#id_s_onlyofficedocspace_docspace_server_url',\n            apiKey: '#id_s_onlyofficedocspace_docspace_api_key',\n        },\n        errors: {\n            url: '#id_s_onlyofficedocspace_docspace_server_url-error',\n            apiKey: '#id_s_onlyofficedocspace_docspace_api_key-error',\n        }\n    };\n\n    const STEPS = {\n        CONNECTED: 'connected',\n        CHECK_URL: 'check_url',\n        CHECK_API_KEY: 'check_api_key',\n    };\n\n    const state = {\n        step: STEPS.CONNECTED,\n        isUrlValid: false,\n    };\n\n    const setState = function(newState) {\n        render({...state, ...newState});\n    };\n\n    const render = async function(state) {\n        const isCheckingUrl = Boolean(state.isCheckingUrl);\n        const isConnecting = Boolean(state.isConnecting);\n\n        document.querySelector(selectors.notifications).innerHTML = '';\n\n        document.querySelector(selectors.fieldRows.url).classList.toggle('disabled', state.step === STEPS.CONNECTED);\n        document.querySelector(selectors.fieldRows.apiKey).classList.toggle('disabled', state.step !== STEPS.CHECK_API_KEY);\n\n        document.querySelector(selectors.buttons.checkUrl).classList.toggle('hidden', state.step === STEPS.CONNECTED);\n        document.querySelector(selectors.buttons.connect).classList.toggle('hidden', state.step === STEPS.CONNECTED);\n        document.querySelector(selectors.buttons.change).classList.toggle('hidden', state.step !== STEPS.CONNECTED);\n        document.querySelector(selectors.buttons.disconnect).classList.toggle('hidden', state.step !== STEPS.CONNECTED);\n\n        document.querySelector(selectors.icons.spinner).classList.toggle('hidden', !isCheckingUrl);\n        document.querySelector(selectors.icons.rightArrow).classList.toggle('hidden', isCheckingUrl);\n        document.querySelector(selectors.icons.checkMark).classList\n            .toggle('hidden', !state.isUrlValid);\n\n        document.querySelector(selectors.buttons.connect).disabled = state.step !== STEPS.CHECK_API_KEY || isConnecting;\n        document.querySelector(selectors.buttons.checkUrl).disabled = isCheckingUrl;\n\n        document.querySelector(selectors.errors.url).classList.toggle('hidden', !(state.errors && state.errors.url));\n        document.querySelector(selectors.errors.apiKey).classList.toggle('hidden', !(state.errors && state.errors.apiKey));\n\n        if (state.errors) {\n            const errorMessages = [];\n            if (state.errors.url) {\n                document.querySelector(selectors.errors.url).textContent = state.errors.url;\n                errorMessages.push(state.errors.url);\n            }\n\n            if (state.errors.apiKey) {\n                document.querySelector(selectors.errors.apiKey).textContent = state.errors.apiKey;\n                errorMessages.push(state.errors.apiKey);\n            }\n\n            if (state.errors.general) {\n                errorMessages.push(state.errors.general);\n            }\n\n            errorMessages.forEach(async(error) => {\n                await Notification.addNotification({\n                    message: error,\n                    type: 'error'\n                });\n            });\n        }\n    };\n\n    const handleCheckUrl = async function() {\n        state.step = STEPS.CHECK_URL;\n        state.isUrlValid = false;\n        setState({isCheckingUrl: true});\n\n        const url = document.querySelector(selectors.inputs.url).value.trim();\n\n        // Check if the URL is empty.\n        if (url.length === 0) {\n            setState({errors: {\n                url: await Str.getString('validationerror:emptyurl', 'onlyofficedocspace')\n            }});\n            return;\n        }\n\n        // Check if the URL is valid.\n        try {\n            new URL(url);\n        } catch (TypeError) {\n            setState({errors: {\n                url: await Str.getString('validationerror:invalidurl', 'onlyofficedocspace')\n            }});\n            return;\n        }\n\n        const result = await Repository.checkDocSpaceConnectivity(url);\n\n        if (result.status && result.status === 'success') {\n            state.isUrlValid = true;\n            state.step = STEPS.CHECK_API_KEY;\n            setState({});\n            return;\n        }\n\n        if (result.errors) {\n            setState({errors: {url: result.errors[0]}});\n        }\n    };\n\n    const handleConnect = async function(event) {\n        const connectButton = event.target;\n        connectButton.disabled = true;\n\n        const url = document.querySelector(selectors.inputs.url).value.trim();\n        const apiKey = document.querySelector(selectors.inputs.apiKey).value.trim();\n\n        if (apiKey.length === 0) {\n            setState({errors: {\n                apiKey: await Str.getString('validationerror:emptyapikey', 'onlyofficedocspace')\n            }});\n            return;\n        }\n\n        const result = await Repository.connectDocSpace(url, apiKey);\n\n        if (result.status && result.status === 'success') {\n            state.step = STEPS.CONNECTED;\n            location.reload();\n            return;\n        }\n\n        if (result.errors) {\n            setState({errors: {apiKey: result.errors[0]}});\n        }\n\n        connectButton.disabled = false;\n    };\n\n    const handleChangeDocSpace = async function() {\n        await Notification.saveCancel(\n            Str.getString('warning', 'onlyofficedocspace'),\n            Str.getString('confirmchange_desc', 'onlyofficedocspace'),\n            Str.getString('change', 'onlyofficedocspace'),\n            async() => {\n                state.step = STEPS.CHECK_URL;\n                state.isUrlValid = false;\n                setState({});\n            },\n            null,\n        );\n    };\n\n    const handleDisconnectDocSpace = async function() {\n        await Notification.saveCancel(\n            Str.getString('warning', 'onlyofficedocspace'),\n            Str.getString('confirmdisconnect_desc', 'onlyofficedocspace'),\n            Str.getString('disconnect', 'onlyofficedocspace'),\n            async() => {\n                const result = await Repository.disconnectDocSpace();\n\n                if (result.success) {\n                    location.reload();\n                    return;\n                }\n\n                if (result.errors) {\n                    setState({errors: {general: result.errors}});\n                }\n            },\n            null,\n        );\n    };\n\n    return {\n        init: async function(connected) {\n            // Bind event handlers.\n            document.querySelector(selectors.buttons.checkUrl).addEventListener('click', handleCheckUrl);\n            document.querySelector(selectors.buttons.connect).addEventListener('click', handleConnect);\n            document.querySelector(selectors.buttons.change).addEventListener('click', handleChangeDocSpace);\n            document.querySelector(selectors.buttons.disconnect).addEventListener('click', handleDisconnectDocSpace);\n\n            // Set initial state.\n            state.step = connected ? STEPS.CONNECTED : STEPS.CHECK_URL;\n            state.isUrlValid = connected;\n            setState({});\n        }\n    };\n});"],"names":["define","Notification","Str","Repository","selectors","url","apiKey","rightArrow","spinner","checkMark","checkUrl","connect","change","disconnect","STEPS","state","step","isUrlValid","setState","newState","render","async","isCheckingUrl","Boolean","isConnecting","document","querySelector","innerHTML","classList","toggle","disabled","errors","errorMessages","textContent","push","general","forEach","addNotification","message","error","type","handleCheckUrl","value","trim","length","getString","URL","TypeError","result","checkDocSpaceConnectivity","status","handleConnect","event","connectButton","target","connectDocSpace","location","reload","handleChangeDocSpace","saveCancel","handleDisconnectDocSpace","disconnectDocSpace","success","init","connected","addEventListener"],"mappings":"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"}