{"version":3,"file":"admin_settings.min.js","sources":["../src/admin_settings.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module     mod_onlyofficedocspace/admin_settings\n * @copyright  2025 Ascensio System SIA <integration@onlyoffice.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n **/\ndefine([\n    'core_form/changechecker',\n    'core/notification',\n    'core/str',\n    'mod_onlyofficedocspace/repository',\n], function(ChangeChecker, Notification, Str, Repository) {\n\n    const selectors = {\n        notifications: '#user-notifications',\n        fieldRows: {\n            url: '#admin-docspace_server_url',\n            apiKey: '#admin-docspace_api_key',\n        },\n        icons: {\n            rightArrow: \".right-arrow\",\n            spinner: \".spinner-border\",\n            checkMark: \".ds-check-icon\",\n        },\n        buttons: {\n            checkUrl: \"#check-docspace-url-btn\",\n            connect: \"#connect-docspace-btn\",\n            change: \"#change-docspace-btn\",\n            disconnect: \"#disconnect-docspace-btn\",\n        },\n        inputs: {\n            url: '#id_s_onlyofficedocspace_docspace_server_url',\n            apiKey: '#id_s_onlyofficedocspace_docspace_api_key',\n        },\n        errors: {\n            url: '#id_s_onlyofficedocspace_docspace_server_url-error',\n            apiKey: '#id_s_onlyofficedocspace_docspace_api_key-error',\n        }\n    };\n\n    const STEPS = {\n        CONNECTED: 'connected',\n        CHECK_URL: 'check_url',\n        CHECK_API_KEY: 'check_api_key',\n    };\n\n    const state = {\n        step: STEPS.CONNECTED,\n        isUrlValid: false,\n    };\n\n    const setState = function(newState) {\n        render({...state, ...newState});\n    };\n\n    const render = async function(state) {\n        const isCheckingUrl = Boolean(state.isCheckingUrl);\n        const isConnecting = Boolean(state.isConnecting);\n\n        document.querySelector(selectors.notifications).innerHTML = '';\n\n        document.querySelector(selectors.fieldRows.url).classList.toggle('disabled', state.step === STEPS.CONNECTED);\n        document.querySelector(selectors.fieldRows.apiKey).classList.toggle('disabled', state.step !== STEPS.CHECK_API_KEY);\n\n        document.querySelector(selectors.buttons.checkUrl).classList.toggle('hidden', state.step === STEPS.CONNECTED);\n        document.querySelector(selectors.buttons.connect).classList.toggle('hidden', state.step === STEPS.CONNECTED);\n        document.querySelector(selectors.buttons.change).classList.toggle('hidden', state.step !== STEPS.CONNECTED);\n        document.querySelector(selectors.buttons.disconnect).classList.toggle('hidden', state.step !== STEPS.CONNECTED);\n\n        document.querySelector(selectors.icons.spinner).classList.toggle('hidden', !isCheckingUrl);\n        document.querySelector(selectors.icons.rightArrow).classList.toggle('hidden', isCheckingUrl);\n        document.querySelector(selectors.inputs.url).classList\n            .toggle('pr-5', state.isUrlValid);\n        document.querySelector(selectors.icons.checkMark).classList\n            .toggle('hidden', !state.isUrlValid);\n\n        document.querySelector(selectors.buttons.connect).disabled = state.step !== STEPS.CHECK_API_KEY || isConnecting;\n        document.querySelector(selectors.buttons.checkUrl).disabled = isCheckingUrl;\n\n        document.querySelector(selectors.errors.url).classList.toggle('hidden', !(state.errors && state.errors.url));\n        document.querySelector(selectors.errors.apiKey).classList.toggle('hidden', !(state.errors && state.errors.apiKey));\n\n        document.querySelectorAll('.ds-create-key-link').forEach(link => {\n            const url = document.querySelector(selectors.inputs.url).value;\n            link.href = state.isUrlValid ? url : '#';\n        });\n\n        if (state.errors) {\n            const errorMessages = [];\n            if (state.errors.url) {\n                document.querySelector(selectors.errors.url).textContent = state.errors.url;\n                errorMessages.push(state.errors.url);\n            }\n\n            if (state.errors.apiKey) {\n                document.querySelector(selectors.errors.apiKey).textContent = state.errors.apiKey;\n                errorMessages.push(state.errors.apiKey);\n            }\n\n            if (state.errors.general) {\n                errorMessages.push(state.errors.general);\n            }\n\n            errorMessages.forEach(async(error) => {\n                await Notification.addNotification({\n                    message: error,\n                    type: 'error'\n                });\n            });\n        }\n    };\n\n    const handleCheckUrl = async function() {\n        state.step = STEPS.CHECK_URL;\n        state.isUrlValid = false;\n        setState({isCheckingUrl: true});\n\n        const url = document.querySelector(selectors.inputs.url).value.trim();\n\n        // Check if the URL is empty.\n        if (url.length === 0) {\n            setState({errors: {\n                url: await Str.getString('validationerror:emptyurl', 'onlyofficedocspace')\n            }});\n            return;\n        }\n\n        // Check if the URL is valid.\n        try {\n            new URL(url);\n        } catch (TypeError) {\n            setState({errors: {\n                url: await Str.getString('validationerror:invalidurl', 'onlyofficedocspace')\n            }});\n            return;\n        }\n\n        const result = await Repository.checkDocSpaceConnectivity(url);\n\n        if (result.status && result.status === 'success') {\n            state.isUrlValid = true;\n            state.step = STEPS.CHECK_API_KEY;\n            setState({});\n            return;\n        }\n\n        if (result.errors) {\n            setState({errors: {url: result.errors[0]}});\n        }\n    };\n\n    const handleConnect = async function(event) {\n        const connectButton = event.target;\n        connectButton.disabled = true;\n\n        const url = document.querySelector(selectors.inputs.url).value.trim();\n        const apiKey = document.querySelector(selectors.inputs.apiKey).value.trim();\n\n        if (apiKey.length === 0) {\n            setState({errors: {\n                apiKey: await Str.getString('validationerror:emptyapikey', 'onlyofficedocspace')\n            }});\n            return;\n        }\n\n        const result = await Repository.connectDocSpace(url, apiKey);\n\n        if (result.status && result.status === 'success') {\n            ChangeChecker.disableAllChecks();\n            state.step = STEPS.CONNECTED;\n            location.reload();\n            return;\n        }\n\n        if (result.errors) {\n            setState({errors: {apiKey: result.errors[0]}});\n        }\n\n        connectButton.disabled = false;\n    };\n\n    const handleChangeDocSpace = async function() {\n        await Notification.saveCancel(\n            Str.getString('warning', 'onlyofficedocspace'),\n            Str.getString('confirmchange_desc', 'onlyofficedocspace'),\n            Str.getString('change', 'onlyofficedocspace'),\n            async() => {\n                state.step = STEPS.CHECK_URL;\n                state.isUrlValid = false;\n                setState({});\n            },\n            null,\n        );\n    };\n\n    const handleDisconnectDocSpace = async function() {\n        await Notification.saveCancel(\n            Str.getString('warning', 'onlyofficedocspace'),\n            Str.getString('confirmdisconnect_desc', 'onlyofficedocspace'),\n            Str.getString('disconnect', 'onlyofficedocspace'),\n            async() => {\n                const result = await Repository.disconnectDocSpace();\n\n                if (result.success) {\n                    location.reload();\n                    return;\n                }\n\n                if (result.errors) {\n                    setState({errors: {general: result.errors}});\n                }\n            },\n            null,\n        );\n    };\n\n    const resetStepToCheckUrl = function() {\n        state.step = STEPS.CHECK_URL;\n        state.isUrlValid = false;\n        setState({});\n    };\n\n    const updateClearButton = function(event) {\n        const input = event.target;\n        const wrapper = input.closest(\".ds-input-wrapper\");\n        const clearButton = wrapper.querySelector('.ds-clear-btn');\n        const focusedAndNonEmpty = input.value && document.activeElement === input;\n        input.classList.toggle('pr-5', focusedAndNonEmpty);\n        clearButton.classList.toggle('hidden', !focusedAndNonEmpty);\n    };\n\n    const resetInputValue = function(event) {\n        if (event.target.closest(\".ds-clear-btn\")) {\n            const wrapper = event.target.closest(\".ds-input-wrapper\");\n            const input = wrapper.querySelector(\"input\");\n            input.value = \"\";\n            input.dispatchEvent(new Event(\"input\", { bubbles: true }));\n            input.focus();\n        }\n    };\n\n    return {\n        init: async function(connected) {\n            // Bind event handlers.\n            document.querySelector(selectors.buttons.checkUrl).addEventListener('click', handleCheckUrl);\n            document.querySelector(selectors.buttons.connect).addEventListener('click', handleConnect);\n            document.querySelector(selectors.buttons.change).addEventListener('click', handleChangeDocSpace);\n            document.querySelector(selectors.buttons.disconnect).addEventListener('click', handleDisconnectDocSpace);\n\n            document.querySelector(selectors.inputs.url).addEventListener('input', resetStepToCheckUrl);\n            document.querySelector(selectors.inputs.url).addEventListener('focus', resetStepToCheckUrl);\n            document.querySelector(selectors.inputs.url).addEventListener('input', updateClearButton);\n            document.querySelector(selectors.inputs.url).addEventListener('focus', updateClearButton);\n            document.querySelector(selectors.inputs.url).addEventListener('blur', e => {\n                setTimeout(() => {\n                    updateClearButton(e);\n                }, 200);\n            });\n\n            document.querySelector(selectors.inputs.apiKey).addEventListener('input', updateClearButton);\n            document.querySelector(selectors.inputs.apiKey).addEventListener('focus', updateClearButton);\n            document.querySelector(selectors.inputs.apiKey).addEventListener('blur', e => {\n                setTimeout(() => {\n                    updateClearButton(e);\n                }, 200);\n            });\n\n            document.addEventListener(\"click\", resetInputValue);\n\n            // Set initial state.\n            state.step = connected ? STEPS.CONNECTED : STEPS.CHECK_URL;\n            state.isUrlValid = connected;\n            setState({});\n        }\n    };\n});"],"names":["define","ChangeChecker","Notification","Str","Repository","selectors","url","apiKey","rightArrow","spinner","checkMark","checkUrl","connect","change","disconnect","STEPS","state","step","isUrlValid","setState","newState","render","async","isCheckingUrl","Boolean","isConnecting","document","querySelector","innerHTML","classList","toggle","disabled","errors","querySelectorAll","forEach","link","value","href","errorMessages","textContent","push","general","addNotification","message","error","type","handleCheckUrl","trim","length","getString","URL","TypeError","result","checkDocSpaceConnectivity","status","handleConnect","event","connectButton","target","connectDocSpace","disableAllChecks","location","reload","handleChangeDocSpace","saveCancel","handleDisconnectDocSpace","disconnectDocSpace","success","resetStepToCheckUrl","updateClearButton","input","clearButton","closest","focusedAndNonEmpty","activeElement","resetInputValue","dispatchEvent","Event","bubbles","focus","init","connected","addEventListener","e","setTimeout"],"mappings":";;;;;AAoBAA,+CAAO,CACH,0BACA,oBACA,WACA,sCACD,SAASC,cAAeC,aAAcC,IAAKC,kBAEpCC,wBACa,sBADbA,oBAES,CACPC,IAAK,6BACLC,OAAQ,2BAJVF,gBAMK,CACHG,WAAY,eACZC,QAAS,kBACTC,UAAW,kBATbL,kBAWO,CACLM,SAAU,0BACVC,QAAS,wBACTC,OAAQ,uBACRC,WAAY,4BAfdT,iBAiBM,CACJC,IAAK,+CACLC,OAAQ,6CAnBVF,iBAqBM,CACJC,IAAK,qDACLC,OAAQ,mDAIVQ,gBACS,YADTA,gBAES,YAFTA,oBAGa,gBAGbC,MAAQ,CACVC,KAAMF,gBACNG,YAAY,GAGVC,SAAW,SAASC,UACtBC,OAAO,IAAIL,SAAUI,YAGnBC,OAASC,eAAeN,aACpBO,cAAgBC,QAAQR,MAAMO,eAC9BE,aAAeD,QAAQR,MAAMS,iBAEnCC,SAASC,cAActB,yBAAyBuB,UAAY,GAE5DF,SAASC,cAActB,oBAAoBC,KAAKuB,UAAUC,OAAO,WAAYd,MAAMC,OAASF,iBAC5FW,SAASC,cAActB,oBAAoBE,QAAQsB,UAAUC,OAAO,WAAYd,MAAMC,OAASF,qBAE/FW,SAASC,cAActB,kBAAkBM,UAAUkB,UAAUC,OAAO,SAAUd,MAAMC,OAASF,iBAC7FW,SAASC,cAActB,kBAAkBO,SAASiB,UAAUC,OAAO,SAAUd,MAAMC,OAASF,iBAC5FW,SAASC,cAActB,kBAAkBQ,QAAQgB,UAAUC,OAAO,SAAUd,MAAMC,OAASF,iBAC3FW,SAASC,cAActB,kBAAkBS,YAAYe,UAAUC,OAAO,SAAUd,MAAMC,OAASF,iBAE/FW,SAASC,cAActB,gBAAgBI,SAASoB,UAAUC,OAAO,UAAWP,eAC5EG,SAASC,cAActB,gBAAgBG,YAAYqB,UAAUC,OAAO,SAAUP,eAC9EG,SAASC,cAActB,iBAAiBC,KAAKuB,UACxCC,OAAO,OAAQd,MAAME,YAC1BQ,SAASC,cAActB,gBAAgBK,WAAWmB,UAC7CC,OAAO,UAAWd,MAAME,YAE7BQ,SAASC,cAActB,kBAAkBO,SAASmB,SAAWf,MAAMC,OAASF,qBAAuBU,aACnGC,SAASC,cAActB,kBAAkBM,UAAUoB,SAAWR,cAE9DG,SAASC,cAActB,iBAAiBC,KAAKuB,UAAUC,OAAO,WAAYd,MAAMgB,QAAUhB,MAAMgB,OAAO1B,MACvGoB,SAASC,cAActB,iBAAiBE,QAAQsB,UAAUC,OAAO,WAAYd,MAAMgB,QAAUhB,MAAMgB,OAAOzB,SAE1GmB,SAASO,iBAAiB,uBAAuBC,SAAQC,aAC/C7B,IAAMoB,SAASC,cAActB,iBAAiBC,KAAK8B,MACzDD,KAAKE,KAAOrB,MAAME,WAAaZ,IAAM,OAGrCU,MAAMgB,OAAQ,OACRM,cAAgB,GAClBtB,MAAMgB,OAAO1B,MACboB,SAASC,cAActB,iBAAiBC,KAAKiC,YAAcvB,MAAMgB,OAAO1B,IACxEgC,cAAcE,KAAKxB,MAAMgB,OAAO1B,MAGhCU,MAAMgB,OAAOzB,SACbmB,SAASC,cAActB,iBAAiBE,QAAQgC,YAAcvB,MAAMgB,OAAOzB,OAC3E+B,cAAcE,KAAKxB,MAAMgB,OAAOzB,SAGhCS,MAAMgB,OAAOS,SACbH,cAAcE,KAAKxB,MAAMgB,OAAOS,SAGpCH,cAAcJ,SAAQZ,MAAAA,cACZpB,aAAawC,gBAAgB,CAC/BC,QAASC,MACTC,KAAM,eAMhBC,eAAiBxB,iBACnBN,MAAMC,KAAOF,gBACbC,MAAME,YAAa,EACnBC,SAAS,CAACI,eAAe,UAEnBjB,IAAMoB,SAASC,cAActB,iBAAiBC,KAAK8B,MAAMW,UAG5C,IAAfzC,IAAI0C,mBACJ7B,SAAS,CAACa,OAAQ,CACd1B,UAAWH,IAAI8C,UAAU,2BAA4B,iCAOrDC,IAAI5C,KACV,MAAO6C,uBACLhC,SAAS,CAACa,OAAQ,CACd1B,UAAWH,IAAI8C,UAAU,6BAA8B,+BAKzDG,aAAehD,WAAWiD,0BAA0B/C,QAEtD8C,OAAOE,QAA4B,YAAlBF,OAAOE,cACxBtC,MAAME,YAAa,EACnBF,MAAMC,KAAOF,yBACbI,SAAS,IAITiC,OAAOpB,QACPb,SAAS,CAACa,OAAQ,CAAC1B,IAAK8C,OAAOpB,OAAO,OAIxCuB,cAAgBjC,eAAekC,aAC3BC,cAAgBD,MAAME,OAC5BD,cAAc1B,UAAW,QAEnBzB,IAAMoB,SAASC,cAActB,iBAAiBC,KAAK8B,MAAMW,OACzDxC,OAASmB,SAASC,cAActB,iBAAiBE,QAAQ6B,MAAMW,UAE/C,IAAlBxC,OAAOyC,mBACP7B,SAAS,CAACa,OAAQ,CACdzB,aAAcJ,IAAI8C,UAAU,8BAA+B,+BAK7DG,aAAehD,WAAWuD,gBAAgBrD,IAAKC,WAEjD6C,OAAOE,QAA4B,YAAlBF,OAAOE,cACxBrD,cAAc2D,mBACd5C,MAAMC,KAAOF,qBACb8C,SAASC,SAITV,OAAOpB,QACPb,SAAS,CAACa,OAAQ,CAACzB,OAAQ6C,OAAOpB,OAAO,MAG7CyB,cAAc1B,UAAW,GAGvBgC,qBAAuBzC,uBACnBpB,aAAa8D,WACf7D,IAAI8C,UAAU,UAAW,sBACzB9C,IAAI8C,UAAU,qBAAsB,sBACpC9C,IAAI8C,UAAU,SAAU,uBACxB3B,UACIN,MAAMC,KAAOF,gBACbC,MAAME,YAAa,EACnBC,SAAS,MAEb,OAIF8C,yBAA2B3C,uBACvBpB,aAAa8D,WACf7D,IAAI8C,UAAU,UAAW,sBACzB9C,IAAI8C,UAAU,yBAA0B,sBACxC9C,IAAI8C,UAAU,aAAc,uBAC5B3B,gBACU8B,aAAehD,WAAW8D,qBAE5Bd,OAAOe,QACPN,SAASC,SAITV,OAAOpB,QACPb,SAAS,CAACa,OAAQ,CAACS,QAASW,OAAOpB,YAG3C,OAIFoC,oBAAsB,WACxBpD,MAAMC,KAAOF,gBACbC,MAAME,YAAa,EACnBC,SAAS,KAGPkD,kBAAoB,SAASb,aACzBc,MAAQd,MAAME,OAEda,YADUD,MAAME,QAAQ,qBACF7C,cAAc,iBACpC8C,mBAAqBH,MAAMlC,OAASV,SAASgD,gBAAkBJ,MACrEA,MAAMzC,UAAUC,OAAO,OAAQ2C,oBAC/BF,YAAY1C,UAAUC,OAAO,UAAW2C,qBAGtCE,gBAAkB,SAASnB,UACzBA,MAAME,OAAOc,QAAQ,iBAAkB,OAEjCF,MADUd,MAAME,OAAOc,QAAQ,qBACf7C,cAAc,SACpC2C,MAAMlC,MAAQ,GACdkC,MAAMM,cAAc,IAAIC,MAAM,QAAS,CAAEC,SAAS,KAClDR,MAAMS,gBAIP,CACHC,KAAM1D,eAAe2D,WAEjBvD,SAASC,cAActB,kBAAkBM,UAAUuE,iBAAiB,QAASpC,gBAC7EpB,SAASC,cAActB,kBAAkBO,SAASsE,iBAAiB,QAAS3B,eAC5E7B,SAASC,cAActB,kBAAkBQ,QAAQqE,iBAAiB,QAASnB,sBAC3ErC,SAASC,cAActB,kBAAkBS,YAAYoE,iBAAiB,QAASjB,0BAE/EvC,SAASC,cAActB,iBAAiBC,KAAK4E,iBAAiB,QAASd,qBACvE1C,SAASC,cAActB,iBAAiBC,KAAK4E,iBAAiB,QAASd,qBACvE1C,SAASC,cAActB,iBAAiBC,KAAK4E,iBAAiB,QAASb,mBACvE3C,SAASC,cAActB,iBAAiBC,KAAK4E,iBAAiB,QAASb,mBACvE3C,SAASC,cAActB,iBAAiBC,KAAK4E,iBAAiB,QAAQC,IAClEC,YAAW,KACPf,kBAAkBc,KACnB,QAGPzD,SAASC,cAActB,iBAAiBE,QAAQ2E,iBAAiB,QAASb,mBAC1E3C,SAASC,cAActB,iBAAiBE,QAAQ2E,iBAAiB,QAASb,mBAC1E3C,SAASC,cAActB,iBAAiBE,QAAQ2E,iBAAiB,QAAQC,IACrEC,YAAW,KACPf,kBAAkBc,KACnB,QAGPzD,SAASwD,iBAAiB,QAASP,iBAGnC3D,MAAMC,KAAOgE,UAAYlE,gBAAkBA,gBAC3CC,MAAME,WAAa+D,UACnB9D,SAAS"}